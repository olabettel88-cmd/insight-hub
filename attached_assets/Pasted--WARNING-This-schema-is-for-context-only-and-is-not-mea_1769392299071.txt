-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.activity_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  action character varying NOT NULL,
  ip_address inet,
  user_agent text,
  endpoint character varying,
  query_string text,
  response_status integer,
  response_time_ms integer,
  metadata json DEFAULT '{}'::json,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.admin_audit_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  admin_id uuid,
  action character varying NOT NULL,
  target_user_id uuid,
  target_type character varying,
  changes jsonb,
  reason text,
  ip_address inet,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT admin_audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT admin_audit_logs_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.admins(id),
  CONSTRAINT admin_audit_logs_target_user_id_fkey FOREIGN KEY (target_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.admins (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  is_admin boolean DEFAULT false,
  is_staff boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT admins_pkey PRIMARY KEY (id),
  CONSTRAINT admins_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.api_config (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  api_name character varying NOT NULL,
  api_url character varying NOT NULL,
  api_key character varying,
  is_active boolean DEFAULT true,
  rate_limit integer DEFAULT 100,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT api_config_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ip_intelligence (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  ip_address inet NOT NULL UNIQUE,
  country character varying,
  city character varying,
  isp character varying,
  is_vpn boolean DEFAULT false,
  is_proxy boolean DEFAULT false,
  is_datacenter boolean DEFAULT false,
  threat_level character varying,
  abuse_reports integer DEFAULT 0,
  last_seen timestamp without time zone,
  user_agent_hash character varying,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT ip_intelligence_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_history (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  amount numeric,
  currency character varying DEFAULT 'USD'::character varying,
  plan character varying,
  duration_months integer,
  stripe_payment_id character varying,
  status character varying DEFAULT 'pending'::character varying,
  created_at timestamp without time zone DEFAULT now(),
  completed_at timestamp without time zone,
  CONSTRAINT payment_history_pkey PRIMARY KEY (id),
  CONSTRAINT payment_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.referrals (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  referrer_id uuid NOT NULL,
  referred_user_id uuid,
  referral_code character varying NOT NULL UNIQUE,
  discount_percentage integer DEFAULT 25,
  discount_active boolean DEFAULT true,
  used_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT referrals_pkey PRIMARY KEY (id),
  CONSTRAINT referrals_referrer_id_fkey FOREIGN KEY (referrer_id) REFERENCES public.users(id),
  CONSTRAINT referrals_referred_user_id_fkey FOREIGN KEY (referred_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.request_quota (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  quota_type character varying,
  limit_count integer,
  used_count integer DEFAULT 0,
  reset_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT request_quota_pkey PRIMARY KEY (id),
  CONSTRAINT request_quota_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.search_history (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  query_type character varying,
  query_value text NOT NULL,
  api_used character varying,
  results_count integer,
  found_data jsonb,
  is_premium_result boolean DEFAULT false,
  search_duration_ms integer,
  ip_address inet,
  user_agent text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT search_history_pkey PRIMARY KEY (id),
  CONSTRAINT search_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  session_id character varying NOT NULL UNIQUE,
  user_id uuid NOT NULL,
  refresh_token_hash character varying NOT NULL,
  ip_address inet,
  user_agent text,
  is_active boolean DEFAULT true,
  expires_at timestamp without time zone NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  last_activity_at timestamp without time zone DEFAULT now(),
  CONSTRAINT sessions_pkey PRIMARY KEY (id),
  CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.suspicious_activity (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  activity_type character varying,
  severity character varying,
  ip_address inet,
  description text,
  is_resolved boolean DEFAULT false,
  resolved_by uuid,
  resolved_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT suspicious_activity_pkey PRIMARY KEY (id),
  CONSTRAINT suspicious_activity_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT suspicious_activity_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.admins(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  username character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  subscription_plan character varying DEFAULT 'free'::character varying,
  subscription_started_at timestamp without time zone,
  subscription_ends_at timestamp without time zone,
  daily_search_limit integer DEFAULT 1,
  daily_searches_used integer DEFAULT 0,
  last_search_reset timestamp without time zone DEFAULT now(),
  api_key character varying DEFAULT (gen_random_uuid())::text UNIQUE,
  telegram_code character varying UNIQUE,
  telegram_id character varying,
  is_active boolean DEFAULT true,
  is_banned boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);